---
title: "R Workshop (Code for Pittsburgh)"
author: "Conor Tompkins"
date: "4/10/2018"
output: html_document
#runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = FALSE)
```

#What is R

R is an interpreted programming language for statistics

###RStudio
Integrated Development Environment for R

* Script
* Console
* Enviroment
* Plots

#How Does R Work?

##Basic Functions

* add
* subtract
* strings
```{r}
1
```
```{r}
1 + 2
```
```{r}
10 / 2
```
```{r}
5 * 2
```
```{r}
"this is a string. strings in R are surrounded by quotation marks."
```

Type matters
```{r error = TRUE}
"1" + 1
```

```{r}
str(1)
str("1")
```

##Objects, Functions, and Assignment
Reminder that objects are shown in the Environment panel
```{r error = TRUE}
x
```
```{r}
x <- 1
x
```
```{r}
x <- 1
y <- 5

x + y
```

c() means "concatenate". It creates vectors
```{r}
a <- c(x, y)
a
```
```{r}
z <- sum(a)
z
```

"<-" and "=" do the same thing. To minimize confusion, many people use "<-" for objects and "=" for assigning variables within functions or dataframes

```{r include=FALSE}
library(tibble)
```
```{r}
x <- 1

a <- data_frame(a = 1:5,
                b = 6:10)
a
```
```{r}
#start a line of code with a "#" to make that line a comment
#1 + 1
#code that is "commented out" will not be executed
```

###Logical
"x == y" means "is x equal to y"
```{r}
1 == 2
```

"!" means "not"
```{r}
!FALSE
```

TRUE = 1, FALSE = 0
```{r}
TRUE + FALSE
```
```{r}
TRUE + TRUE
```

###Working Directory
How to set up the working directory
```{r}
getwd()
```

Session menu -> Set working directory -> choose your folder

```{r eval = FALSE}
setwd()
```

##Compare to Excel
R separates the data from the analysis. The data is stored in files (CSV, JSON, etc). The analysis is stored in scripts. This makes it easier to share analysis performed in R. No need to take screenshots of your workflow in Excel. You have a record of everything that was done to the data.

##Compare to other programming languages

#What is the Tidyverse?

A group of R packages that use a common grammar for wranging, analyzing, modeling, and graphing data

* Focus on dataframes
* Columns and rows
* Everything is a square
    + Most things

##Tidyverse functions

* **select** columns
* **filter** rows
* **mutate** new columns
* **group_by** rows and **summarize**
* **ggplot2** your data

```{r load_data_hidden, include=FALSE}
library(tidyverse)
library(lubridate)
df <- read_csv("https://raw.githubusercontent.com/conorotompkins/pittsburgh_311/master/data/pittsburgh_311_2018_04_10.csv")

colnames(df) <- tolower(colnames(df))

df %>%
  mutate(date = ymd(str_sub(created_on, 1, 10)),
         time = hms(str_sub(created_on, 11, 18)),
         month = month(date, label = TRUE), 
         year = year(date),
         yday = yday(date)) -> df
```

Explore the data
```{r}
df #simply type the name of the object to preview it
```
```{r}
glimpse(df)
```

%>% means "and then"

%>% passes the dataframe to the next function
```{r}
df %>% #select the dataframe
  select(date, request_type) #select the date and request_type columns
```
```{r}
df %>% 
  select(date, request_type) %>% 
  filter(request_type == "Potholes")
```
```{r}
#mutate
library(lubridate)
df %>% 
  select(date, request_type) %>% 
  filter(request_type == "Potholes") %>% 
  mutate(weekday = wday(date, label = TRUE))
```
```{r}
#group_by and summarize
(df %>% 
  select(date, request_type) %>% 
  filter(request_type == "Potholes") %>% 
  mutate(month = month(date, label = TRUE)) %>% 
  group_by(request_type, month) %>% 
  summarize(count = n()) %>% 
  arrange(desc(count)) -> df_potholes_month)
```

Put your code in parentheses to execute it AND print the output in the console

#Making graphs with 311 data

Steps

1. Load the data from WPRDC
2. Examine the data in R
3. Filter out non-pothole reports
4. Summarize total requests per month/year
```{r}
df_potholes_month %>% 
  ggplot(aes(month, count)) +
  geom_col()
```

Make it pretty. Add a title, subtitle, axes labels, captions, and themes
```{r}
df_potholes_month %>% 
  ggplot(aes(month, count)) +
  geom_col() + 
  labs(title = "Pothole requests to Pittsburgh 311",
       x = "",
       y = "Number of requests",
       caption = "Source: Western Pennsylvania Regional Datacenter") +
  theme_bw()
```
```{r}
df %>% 
  filter(request_type == "Potholes") %>% 
  count(date)
```
```{r}
#assign labels to objects to save some typing
my_title <- "Pothole requests to Pittsburgh 311"
my_caption <- "Source: Western Pennsylvania Regional Datacenter"
df %>% 
  filter(request_type == "Potholes") %>% 
  count(date) %>% 
  ggplot(aes(date, n)) +
  geom_line() +
  labs(title = my_title,
       x = "",
       y = "Number of requests",
       caption = my_caption) +
  theme_bw(base_family = 18)
```

Note that ggplot2 automatically formats the axis labels for dates
```{r}
df %>% 
  select(request_type, date) %>% 
  filter(request_type == "Potholes") %>% 
  mutate(year = year(date),
         yday = yday(date)) %>% 
  count(year, yday) %>%  #shortcut for group_by + summarize for counting. returns "n"
  ggplot(aes(yday, n, color = as.factor(year))) +
  geom_line() +
  labs(title = my_title,
       x = "Day of the year",
       y = "Number of requests",
       caption = my_caption) +
  theme_bw(base_family = 18)
```
```{r}
df %>% 
  select(request_type, date) %>% 
  filter(request_type == "Potholes") %>% 
  mutate(year = year(date),
         yday = yday(date)) %>% 
  arrange(date) %>% #always arrange your data for cumulative sums
  group_by(year, yday) %>%
  summarize(n = n()) %>% 
  ungroup() %>% 
  group_by(year) %>% 
  mutate(cumsum = cumsum(n)) %>% 
  ggplot(aes(yday, cumsum, color = as.factor(year))) +
  geom_line(size = 2) +
  labs(title = my_title,
       x = "Day of the year",
       y = "Cumulative sum of requests",
       caption = my_caption) +
  scale_color_discrete("Year") +
  theme_bw(base_family = 18)
```

##Making an area chart in R
https://twitter.com/conor_tompkins/status/967028854652129281

```{r load_environment}
library(tidyverse)
library(lubridate)
library(viridis)
library(scales)
library(ggmap)
```

Since the 2015 year is incomplete, filter it out
```{r load_data, eval=FALSE}
df <- read_csv("https://raw.githubusercontent.com/conorotompkins/pittsburgh_311/master/data/pittsburgh_311_2018_04_10.csv")

colnames(df) <- tolower(colnames(df))

df %>%
  mutate(date = ymd(str_sub(created_on, 1, 10)),
         time = hms(str_sub(created_on, 11, 18)),
         month = month(date, label = TRUE), 
         year = year(date),
         yday = yday(date)) %>% 
  filter(date >= "2016-01-01",
         date <= "2018-01-01") -> df
```
```{r top_requests, message=FALSE, warning=FALSE, cache=TRUE, paged.print=FALSE}
df %>% 
  count(request_type, sort = TRUE) %>% 
  top_n(5) %>% 
  ungroup() -> df_top_requests
```
```{r area_chart, fig.height=6, fig.width=12, message=FALSE, warning=FALSE, cache=TRUE, paged.print=FALSE}
df %>% 
  semi_join(df_top_requests) %>% #joins are ways to combine two dataframes
  count(request_type, month) %>% 
  ggplot(aes(month, n, group = request_type, fill = request_type)) +
  geom_area() +
  scale_fill_viridis("Request type", discrete = TRUE, option = "D") +
  scale_y_continuous(expand = c(0, 0),
                     labels = comma) +
  scale_x_discrete(expand = c(0, 0)) +
  labs(title = "Top 5 types of 311 requests in Pittsburgh",
       subtitle = "2016 to 2017",
       x = "",
       y = "Number of requests",
       caption = my_caption) +
  theme_bw(base_family = 18) +
  theme(panel.grid = element_blank())
```

##Mapping in R
```{r map, eval=FALSE, fig.height=12, fig.width=12, message=FALSE, warning=FALSE, paged.print=FALSE}
df %>% 
  select(request_type, x, y) %>% 
  filter(!is.na(x), !is.na(y),
         request_type %in% c("Potholes", "Snow/Ice Removal")) -> df_map

city_map <-  get_map("North Oakland, Pittsburgh, PA", 
                     zoom = 12,
                     maptype = "toner", 
                     source = "stamen")

city_map <- ggmap(city_map)
```
```{r eval = FALSE, error = TRUE}
#Put the data on the map
city_map +
  stat_density_2d(data = df_map, #Using a 2d contour
                  aes(x, #longitude
                      y, #latitude
                      fill = request_type, #Use the count of arrests as the fill
                      alpha = ..level..), #Use alpha so you can see the map under the data
                  geom = "polygon") + #We want the contour in a polygon
  facet_wrap(~request_type) +
  scale_alpha_continuous(range = c(.1, 1)) +
  guides(fill = FALSE,
         alpha = guide_legend("Number of requests")) +
  labs(title = "The Two Seasons In Pittsburgh",
       subtitle = "311 requests in Pittsburgh",
       x = "",
       y = "",
       caption = my_caption) +
  theme_bw(base_family = 18) +
  theme(axis.text = element_blank())
```