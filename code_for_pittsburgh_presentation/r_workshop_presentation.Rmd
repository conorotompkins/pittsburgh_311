---
title: "R Workshop (Code for Pittsburgh)"
author: "Conor Tompkins"
date: "4/10/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

##What is R
R is an interpreted programming language for statistics

##Intro to RStudio
RStudio is an Integrated Development Environment for R
4 panels
-Scripts
-Console
-Environment
-Files

##How Does R Work?
```{r}
1
```

```{r}
1 + 2
```

```{r}
10 / 2
```

```{r}
5 * 2
```

```{r}
"this is a string. strings in R are surrounded by quotation marks."
```

```{r error = TRUE}
"1" + 1
```

```{r}
str(1)
str("1")
```

Objects vs. Functions

Assignment vs. Equals



##Compare to Excel
R separates the data from the analysis. The data is stored in files (CSVs, JSON, etc). The analysis is stored in scripts. This makes it easier to share analysis performed in R. No need to take screenshots of your workflow in Excel. You have a record of everything that was done to the data.

##Compare to other programming languages

##Basic Functions
Functions to cover
-add
-subtract
-strings
-assign

##What is the Tidyverse?

##How does the Tidyverse work?

Focus on dataframes
Columns and rows
Everything* is a square
*Most things

```{r}
#print example df
```

Tidyverse functions
-**select** columns
-**filter** rows
-**mutate** new columns
-**group_by** rows and **summarize**
-**ggplot2** your data

```{r load_data_hidden, include=FALSE}
library(tidyverse)
library(lubridate)
df <- read_csv("https://raw.githubusercontent.com/conorotompkins/pittsburgh_311/master/data/pittsburgh_311_2018_04_10.csv")

colnames(df) <- tolower(colnames(df))

df %>%
  mutate(date = ymd(str_sub(created_on, 1, 10)),
         time = hms(str_sub(created_on, 11, 18)),
         month = month(date, label = TRUE), 
         year = year(date),
         yday = yday(date)) -> df
```

Explore the data
```{r}
df
```
```{r}
glimpse(df)
```

%>% means "and then"
%>% passes the dataframe to the next function

```{r}
df %>% #select the dataframe
  select(date, request_type) #select the date and request_type columns
```

```{r}
df %>% 
  select(date, request_type) %>% 
  filter(request_type == "Potholes")
```

```{r}
#mutate
library(lubridate)
df %>% 
  select(date, request_type) %>% 
  filter(request_type == "Potholes") %>% 
  mutate(weekday = wday(date, label = TRUE))
```

```{r}
#group_by and summarize
df %>% 
  select(date, request_type) %>% 
  filter(request_type == "Potholes") %>% 
  mutate(month = month(date, label = TRUE)) %>% 
  group_by(request_type, month) %>% 
  summarize(count = n()) -> df_potholes_month
```

##Making graphs with 311 data
-load the data from WPRDC
-examine the data in R
-filter out non-pothole reports
-summarize total requests per month/year

```{r}
df_potholes_month %>% 
  ggplot(aes(month, count)) +
  geom_col()
```

Make it pretty
```{r}
df_potholes_month %>% 
  ggplot(aes(month, count)) +
  geom_col() + 
  labs(title = "Pothole requests to Pittsburgh 311",
       x = "",
       y = "Number of requests",
       caption = "Source: Western Pennsylvania Regional Datacenter") +
  theme_bw()
```

```{r}
df %>% 
  filter(request_type == "Potholes") %>% 
  count(date)
```

```{r}
#assign labels to objects to save some typing
my_title <- "Pothole requests to Pittsburgh 311"
my_caption <- "Source: Western Pennsylvania Regional Datacenter"
df %>% 
  filter(request_type == "Potholes") %>% 
  count(date) %>% 
  ggplot(aes(date, n)) +
  geom_line() +
  labs(title = my_title,
       x = "",
       y = "Number of requests",
       caption = my_caption) +
  theme_bw()
```

```{r}
df %>% 
  select(request_type, date) %>% 
  filter(request_type == "Potholes") %>% 
  mutate(year = year(date),
         yday = yday(date)) %>% 
  count(year, yday) %>%  #shortcut for group_by + summarize for counting. returns "n"
  ggplot(aes(yday, n, color = as.factor(year))) +
  geom_line() +
  theme_bw()
```

```{r}
df %>% 
  select(request_type, date) %>% 
  filter(request_type == "Potholes") %>% 
  mutate(year = year(date),
         yday = yday(date)) %>% 
  arrange(date) %>% #always arrange your data for cumulative sums
  group_by(year, yday) %>%
  summarize(n = n()) %>% 
  ungroup() %>% 
  group_by(year) %>% 
  mutate(cumsum = cumsum(n)) %>% 
  ggplot(aes(yday, cumsum, color = as.factor(year))) +
  geom_line(size = 2) +
  theme_bw()
```

##Make this graph in R
https://twitter.com/conor_tompkins/status/967028854652129281


```{r load_environment}
library(tidyverse)
library(lubridate)
library(viridis)
library(scales)
library(ggmap)
```

```{r load_data}
df <- read_csv("https://raw.githubusercontent.com/conorotompkins/pittsburgh_311/master/data/pittsburgh_311_2018_04_10.csv")

colnames(df) <- tolower(colnames(df))

df %>%
  mutate(date = ymd(str_sub(created_on, 1, 10)),
         time = hms(str_sub(created_on, 11, 18)),
         month = month(date, label = TRUE), 
         year = year(date),
         yday = yday(date)) -> df
```

```{r top_requests, message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}
df %>% 
  count(request_type, sort = TRUE) %>% 
  top_n(5) %>% 
  ungroup() -> df_top_requests
```

```{r area_chart, fig.height=6, fig.width=12, message=FALSE, warning=FALSE, cache=TRUE, paged.print=FALSE}
df %>% 
  semi_join(df_top_requests) %>% 
  count(request_type, month) %>% 
  ggplot(aes(month, n, group = request_type, fill = request_type)) +
  geom_area() +
  scale_fill_viridis("Request type", discrete = TRUE, option = "D") +
  scale_y_continuous(expand = c(0, 0),
                     labels = comma) +
  scale_x_discrete(expand = c(0, 0)) +
  labs(title = "Top 5 types of 311 requests in Pittsburgh",
       x = "",
       y = "Number of requests") +
  theme_bw(base_family = 18) +
  theme(panel.grid = element_blank())
```


##Make this graph in R

```{r map, fig.height=12, fig.width=12, message=FALSE, warning=FALSE, paged.print=FALSE, cache=TRUE}
df %>% 
  select(request_type, x, y) %>% 
  filter(!is.na(x), !is.na(y),
         request_type %in% c("Potholes", "Snow/Ice Removal")) -> df_map

city_map <-  get_map("North Oakland, Pittsburgh, PA", 
                     zoom = 12,
                     maptype = "toner", 
                     source = "stamen")

city_map <- ggmap(city_map)
```

```{r error = TRUE}
#Put the data on the map
city_map +
  stat_density_2d(data = df_map, #Using a 2d contour
                  aes(x, #longitude
                      y, #latitude
                      fill = request_type, #Use the count of arrests as the fill
                      alpha = ..level..), #Use alpha so you can see the map under the data
                  geom = "polygon") + #We want the contour in a polygon
  facet_wrap(~request_type) +
  scale_alpha_continuous(range = c(.1, 1)) +
  guides(fill = FALSE,
         alpha = guide_legend("Number of requests")) +
  labs(title = "The Two Seasons In Pittsburgh",
       subtitle = "311 requests in Pittsburgh",
       x = "",
       y = "") +
  theme_bw(base_family = 18) +
  theme(axis.text = element_blank())
```